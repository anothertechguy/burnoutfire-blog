---
import BaseLayout from '../../components/Layout/BaseLayout.astro';
import { getUserProfile, getWritingStyleReasoning } from '../../utils/agents/knowledge/userProfile';
import { getAllCompetitorProfiles, getCompetitorLearnings } from '../../utils/agents/knowledge/competitorProfiles';
import { getMarketingPlan, getWideMoatAnalysis } from '../../utils/agents/knowledge/marketingPlan';
import { findWideMoatOpportunities } from '../../utils/agents/research/wideMoatAnalysis';
import { SITE_CONFIG } from '../../config';

const userProfile = getUserProfile();
const competitorProfiles = getAllCompetitorProfiles();
const marketingPlan = getMarketingPlan();
const wideMoatOpportunities = findWideMoatOpportunities();

const seo = {
  title: `Agent Learnings | ${SITE_CONFIG.title} Admin`,
  description: 'View agent knowledge and learnings',
};
---

<BaseLayout title="Agent Learnings" description="Agent knowledge base" seo={seo}>
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="mb-8">
        <a href="/admin" class="text-blue-600 hover:text-blue-800 mb-4 inline-block">← Back to Dashboard</a>
        <h1 class="text-3xl font-bold text-gray-900">Agent Learnings & Knowledge Base</h1>
        <p class="text-gray-600 mt-2">See what the agents have learned about you, competitors, and strategy</p>
      </div>

      <!-- User Profile -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Your Profile</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Current Situation</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              <li>• Income Level: <strong>{userProfile.situation.incomeLevel}</strong></li>
              <li>• Dual Income: <strong>{userProfile.situation.dualIncome ? 'Yes' : 'No'}</strong></li>
              <li>• Savings Rate: <strong>{userProfile.situation.savingsRate}%</strong></li>
              <li>• Strategy: <span class="text-xs">{userProfile.situation.currentStrategy}</span></li>
            </ul>
          </div>
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Goals</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              {userProfile.situation.goals.map(goal => (
                <li>• {goal}</li>
              ))}
            </ul>
          </div>
        </div>
      </div>

      <!-- Writing Style Reasoning -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Writing Style Reasoning</h2>
        <div class="prose max-w-none text-sm text-gray-700 whitespace-pre-line">
          {getWritingStyleReasoning()}
        </div>
      </div>

      <!-- Competitor Profiles -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Competitor Profiles</h2>
        {competitorProfiles.length > 0 ? (
          <div class="space-y-4">
            {competitorProfiles.map(profile => (
              <div class="border border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold text-gray-900 mb-2">{profile.name}</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div>
                    <span class="text-gray-600">Avg Word Count:</span>
                    <span class="font-semibold ml-2">{profile.content.averageWordCount}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Readability:</span>
                    <span class="font-semibold ml-2">{profile.content.averageReadability}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Strengths:</span>
                    <span class="ml-2">{profile.content.strengths.join(', ')}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Weaknesses:</span>
                    <span class="ml-2">{profile.content.weaknesses.join(', ')}</span>
                  </div>
                </div>
                <div class="mt-3 pt-3 border-t">
                  <p class="text-sm font-medium text-gray-900 mb-1">Opportunities for Us:</p>
                  <ul class="text-sm text-gray-700 space-y-1">
                    {profile.opportunities.gaps.map(gap => (
                      <li>• {gap}</li>
                    ))}
                  </ul>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="text-center py-8">
            <p class="text-gray-600 mb-4">No competitor research completed yet.</p>
            <button 
              onclick="runCompetitorResearch()"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
            >
              Run Competitor Research
            </button>
          </div>
        )}
      </div>

      <!-- Digital Marketing Plan -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Digital Marketing Plan</h2>
        <div class="space-y-6">
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Positioning</h3>
            <p class="text-sm text-gray-700">{marketingPlan.strategy.positioning}</p>
          </div>
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Unique Value Proposition</h3>
            <p class="text-sm text-gray-700">{marketingPlan.strategy.uniqueValueProposition}</p>
          </div>
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Competitive Advantages</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              {marketingPlan.strategy.competitiveAdvantage.map(adv => (
                <li>• {adv}</li>
              ))}
            </ul>
          </div>
          <div>
            <h3 class="font-medium text-gray-900 mb-2">Content Gaps Identified</h3>
            <div class="space-y-2">
              {marketingPlan.content.contentGaps.map(gap => (
                <div class="border-l-4 border-blue-500 pl-3 py-1">
                  <p class="text-sm font-medium text-gray-900">{gap.topic}</p>
                  <p class="text-xs text-gray-600">Priority: {gap.opportunity} - {gap.reasoning}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      <!-- Wide Moat Opportunities -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Wide Moat Opportunities</h2>
        <p class="text-sm text-gray-600 mb-4">Niches with defensible competitive advantages</p>
        <div class="space-y-4">
          {wideMoatOpportunities.map((opp, i) => (
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex items-start justify-between mb-2">
                <h3 class="font-semibold text-gray-900">{i + 1}. {opp.niche}</h3>
                <span class={`px-2 py-1 text-xs rounded ${
                  opp.competition === 'very_low' || opp.competition === 'low' 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-yellow-100 text-yellow-800'
                }`}>
                  {opp.competition.replace('_', ' ')}
                </span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-3">
                <div>
                  <span class="text-gray-600">Keyword:</span>
                  <span class="font-semibold ml-2">{opp.keyword}</span>
                </div>
                <div>
                  <span class="text-gray-600">Difficulty:</span>
                  <span class="font-semibold ml-2 capitalize">{opp.difficulty}</span>
                </div>
                <div>
                  <span class="text-gray-600">Timeline:</span>
                  <span class="font-semibold ml-2">{opp.timeline}</span>
                </div>
                <div>
                  <span class="text-gray-600">Moat:</span>
                  <span class="ml-2">{opp.moat}</span>
                </div>
              </div>
              <div class="mt-3 pt-3 border-t">
                <p class="text-sm font-medium text-gray-900 mb-1">Strategy:</p>
                <p class="text-sm text-gray-700">{opp.strategy}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>

  <script>
    async function runCompetitorResearch() {
      const button = event.target;
      button.disabled = true;
      button.textContent = 'Researching...';
      
      try {
        // In production, this would call an API endpoint
        // For now, show message
        alert('Competitor research started! This would scrape competitors in production.');
        
        // Simulate research
        setTimeout(() => {
          alert('Research complete! Refresh page to see results.');
          location.reload();
        }, 2000);
      } catch (error) {
        console.error('Error:', error);
        alert('Error running research. Check console.');
        button.disabled = false;
        button.textContent = 'Run Competitor Research';
      }
    }
  </script>
</BaseLayout>
